<!-- Chatbot Widget with Backend Integration -->
<script>
// Embedded configuration to avoid MIME type issues
window.ChatbotConfig = {
    // apiUrl: 'http://127.0.0.1:8000',  // Local development
    apiUrl: 'https://two00rx-io-chatbot.onrender.com',  // Production
    apiKey: 'xK8TYfRDskX9xmJUuEbHrQbowHy6SOv3eXHivkzvUabK6i1SaFRmJD8AyuWAAKJvocDaOOI7ulqYKIqnExEiMRXJRWB78rM8SV2EUgpWHUdMKNGKo6avD22PrrgqMryF3FepkqNTjsGatwptITAmTpgm4zR6CCbQsgR4mkHXdKtEHDS3RDG7ziKcyBx0rbunFXI9Ce2A9dMhiNNUpGMtabwZSPy7PLfkQUCSU87pKzklR1Qg3vX2DZBHHbg5UGdE'  // Must match API_KEY in backend .env
};

// Chatbot with backend integration
class BackendChatbot {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.apiUrl = window.ChatbotConfig?.apiUrl || 'https://two00rx-io-chatbot.onrender.com';
        this.apiKey = window.ChatbotConfig?.apiKey || null;
        this.init();
    }

    init() {
        this.createChatInterface();
        this.bindEvents();
    }

    createChatInterface() {
        // Create chat launcher
        const launcher = document.createElement('div');
        launcher.id = 'chat-launcher';
        launcher.innerHTML = 'ðŸ’¬ Questions about my experience?';
        launcher.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px 14px;
            border-radius: 20px;
            cursor: pointer;
            z-index: 1000;
            font-family: sans-serif;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease;
        `;

        launcher.addEventListener('mouseenter', () => {
            launcher.style.backgroundColor = '#555';
        });
        
        launcher.addEventListener('mouseleave', () => {
            launcher.style.backgroundColor = '#333';
        });

        // Create chat box
        const chatBox = document.createElement('div');
        chatBox.id = 'chat-box';
        chatBox.style.cssText = `
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 320px;
            max-height: 400px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: sans-serif;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: none;
        `;

        chatBox.innerHTML = `
            <div style="background: #333; color: white; padding: 12px; border-radius: 8px 8px 0 0; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
                <span>Chat with Corey</span>
                <span id="chat-close" style="cursor: pointer; font-size: 20px; line-height: 1;">&times;</span>
            </div>
            <div id="chat-messages" style="height: 250px; overflow-y: auto; padding: 10px; background: #f9f9f9;"></div>
            <div style="padding: 10px; border-top: 1px solid #eee; background: white;">
                <input id="chat-input" type="text" placeholder="Ask me something..." 
                       style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; font-size: 14px;">
                <div id="connection-status" style="font-size: 11px; color: #666; margin-top: 4px;"></div>
            </div>
        `;

        document.body.appendChild(launcher);
        document.body.appendChild(chatBox);
    }

    bindEvents() {
        const launcher = document.getElementById('chat-launcher');
        const chatBox = document.getElementById('chat-box');
        const closeBtn = document.getElementById('chat-close');
        const input = document.getElementById('chat-input');

        launcher.addEventListener('click', () => this.toggleChat());
        closeBtn.addEventListener('click', () => this.toggleChat());
        
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage(e.target.value);
                e.target.value = '';
            }
        });
    }

    async toggleChat() {
        const chatBox = document.getElementById('chat-box');
        this.isOpen = !this.isOpen;
        chatBox.style.display = this.isOpen ? 'block' : 'none';
        
        if (this.isOpen && this.messages.length === 0) {
            // Test backend connection when chat opens
            await this.testConnection();
            if (this.apiKey && this.apiKey !== 'YOUR_API_KEY_HERE') {
                this.addMessage('bot', "Hello! I'm Corey's AI assistant powered by OpenAI. I can help answer questions about his experience, skills, and background. What would you like to know?");
            } else {
                this.addMessage('bot', "Hello! I'm Corey's assistant. I'm currently in demo mode with limited responses. For full AI capabilities, the API key needs to be configured. What would you like to know about Corey?");
            }
        }
        
        // Focus input when chat opens
        if (this.isOpen) {
            setTimeout(() => {
                document.getElementById('chat-input').focus();
            }, 100);
        }
    }

    async testConnection() {
        const statusEl = document.getElementById('connection-status');
        try {
            const response = await fetch(`${this.apiUrl}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Backend response:', data); // Debug log
                
                // Handle both debug and production responses
                if (data.status && (data.status.includes('Backend is running') || data.status.includes('running'))) {
                    if (this.apiKey && this.apiKey !== 'YOUR_API_KEY_HERE') {
                        statusEl.textContent = 'ðŸŸ¢ Connected to AI assistant';
                        statusEl.style.color = '#28a745';
                    } else {
                        statusEl.textContent = 'ðŸŸ¡ Connected (demo mode)';
                        statusEl.style.color = '#ffc107';
                    }
                } else {
                    throw new Error(`Unexpected status: ${data.status}`);
                }
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
        } catch (error) {
            console.warn('Backend connection test failed:', error);
            statusEl.textContent = 'ðŸ”´ Using offline mode';
            statusEl.style.color = '#dc3545';
        }
    }

    addMessage(sender, text) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = `
            margin-bottom: 10px;
            text-align: ${sender === 'user' ? 'right' : 'left'};
        `;
        
        const messageBubble = document.createElement('div');
        messageBubble.style.cssText = `
            display: inline-block;
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            background: ${sender === 'user' ? '#007bff' : '#f8f9fa'};
            color: ${sender === 'user' ? 'white' : '#212529'};
            border: ${sender === 'user' ? 'none' : '1px solid #dee2e6'};
            font-size: 14px;
            line-height: 1.4;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: pre-wrap;
        `;
        messageBubble.textContent = text;
        
        messageDiv.appendChild(messageBubble);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        this.messages.push({ sender, text });
    }

    async sendMessage(text) {
        if (!text.trim()) return;
        
        this.addMessage('user', text);
        this.showTyping();
        
        // Check if we have API key and backend is available
        if (this.apiKey && this.apiKey !== 'YOUR_API_KEY_HERE') {
            try {
                const response = await this.queryBackend(text);
                this.hideTyping();
                this.addMessage('bot', response);
                return;
            } catch (error) {
                console.warn('Backend request failed:', error);
                // Fall through to fallback response
            }
        }
        
        // Use fallback responses
        this.hideTyping();
        const fallbackResponse = this.generateFallbackResponse(text);
        this.addMessage('bot', fallbackResponse);
        
        // Update status if using fallback
        const statusEl = document.getElementById('connection-status');
        if (!this.apiKey || this.apiKey === 'YOUR_API_KEY_HERE') {
            statusEl.textContent = 'ðŸŸ¡ Demo mode - limited responses';
            statusEl.style.color = '#ffc107';
        } else {
            statusEl.textContent = 'ðŸ”´ Backend unavailable';
            statusEl.style.color = '#dc3545';
        }
    }
    
    async queryBackend(question) {
        const response = await fetch(`${this.apiUrl}/ask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-API-Key': this.apiKey
            },
            body: JSON.stringify({ 
                question: question
            })
        });
        
        if (!response.ok) {
            if (response.status === 403) {
                throw new Error('Authentication failed - API key invalid');
            } else if (response.status === 429) {
                throw new Error('Rate limit exceeded - too many requests');
            } else if (response.status === 422) {
                throw new Error('Invalid question format');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        const data = await response.json();
        return data.answer || 'I received your question but got an unexpected response format.';
    }
    
    showTyping() {
        const messagesContainer = document.getElementById('chat-messages');
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.style.cssText = `
            margin-bottom: 10px;
            text-align: left;
        `;
        
        typingDiv.innerHTML = `
            <div style="display: inline-block; padding: 8px 12px; border-radius: 12px; background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; font-size: 14px; font-style: italic;">
                <span class="typing-dots">Thinking</span><span class="dots">...</span>
            </div>
        `;
        
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Animate dots
        let dotCount = 0;
        this.typingInterval = setInterval(() => {
            const dotsEl = typingDiv.querySelector('.dots');
            if (dotsEl) {
                dotCount = (dotCount + 1) % 4;
                dotsEl.textContent = '.'.repeat(dotCount);
            }
        }, 500);
    }
    
    hideTyping() {
        const typing = document.getElementById('typing-indicator');
        if (typing) {
            typing.remove();
        }
        if (this.typingInterval) {
            clearInterval(this.typingInterval);
            this.typingInterval = null;
        }
    }

    generateFallbackResponse(question) {
        const q = question.toLowerCase();
        
        // Enhanced fallback responses
        if (q.includes('hello') || q.includes('hi') || q.includes('hey')) {
            return "Hello! Great to meet you. I can help answer questions about Corey's professional background and experience. What would you like to know?";
        } else if (q.includes('experience') || q.includes('work') || q.includes('job') || q.includes('career')) {
            return "Corey has extensive experience as a System Administrator with expertise in cloud administration, PowerShell, Python, and DevOps practices. He has worked in both government and private sector environments, bringing strong technical leadership and automation skills to every role.";
        } else if (q.includes('skill') || q.includes('technology') || q.includes('tech') || q.includes('technical')) {
            return "Corey's key technical skills include:\n\nâ€¢ Windows Server Administration\nâ€¢ Cloud Architecture (AWS/Azure)\nâ€¢ PowerShell scripting and automation\nâ€¢ Python development\nâ€¢ Network Administration\nâ€¢ DevOps practices and CI/CD\nâ€¢ Infrastructure management\nâ€¢ Security best practices";
        } else if (q.includes('contact') || q.includes('reach') || q.includes('email') || q.includes('hire')) {
            return "You can reach Corey at:\nðŸ“§ vinnym@200rx.com\nðŸ’¼ LinkedIn: https://www.linkedin.com/in/coreyvmiller/\n\nFeel free to reach out for opportunities, technical discussions, or collaboration!";
        } else if (q.includes('cloud') || q.includes('aws') || q.includes('azure')) {
            return "Corey has extensive cloud experience with both AWS and Azure platforms. He's worked on cloud migrations, infrastructure automation, and implementing best practices for cloud security and cost optimization.";
        } else if (q.includes('python') || q.includes('powershell') || q.includes('script') || q.includes('automation')) {
            return "Corey is proficient in both PowerShell and Python scripting. He uses these tools for automation, system administration tasks, data processing, and building efficient workflows that save time and reduce manual errors.";
        } else if (q.includes('military') || q.includes('veteran') || q.includes('government') || q.includes('security')) {
            return "Corey brings valuable experience from government and military environments, where he developed strong discipline, attention to detail, and the ability to work effectively under pressure while maintaining high security standards.";
        } else if (q.includes('education') || q.includes('learn') || q.includes('study') || q.includes('certifi')) {
            return "Corey is continuously learning and staying current with technology trends. His background includes both formal education and extensive hands-on experience in IT systems and administration. He's always exploring new technologies and methodologies.";
        } else if (q.includes('project') || q.includes('portfolio') || q.includes('recent work')) {
            return "Corey has worked on various projects involving system automation, cloud migrations, and infrastructure optimization. Check out the Projects section above for more details about his recent work and technical achievements.";
        } else if (q.includes('devops') || q.includes('ci/cd') || q.includes('deployment')) {
            return "Corey has strong DevOps experience including CI/CD pipeline implementation, infrastructure as code, automated testing, and deployment strategies. He focuses on creating efficient, reliable workflows that improve development velocity.";
        } else if (q.includes('network') || q.includes('infrastructure') || q.includes('server')) {
            return "Corey has deep expertise in network administration and infrastructure management. He's worked with Windows Server environments, network configuration, security implementations, and large-scale infrastructure projects.";
        } else {
            return "That's a great question! While I have information about Corey's technical background, I'd recommend checking out his full profile above or reaching out to him directly at vinnym@200rx.com for more specific details. Is there anything else about his experience or skills I can help with?";
        }
    }
}

// Initialize chatbot when page loads
document.addEventListener('DOMContentLoaded', () => {
    console.log('Initializing backend-integrated chatbot...');
    new BackendChatbot();
});
</script>
